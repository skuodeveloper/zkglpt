<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
		<style>
			.container {
				width: 100%;
				height: 100%;
				overflow: auto;
				clear: both;
			}
			
			.z_photo {
				width: 100%;
				height: 3rem;
				padding: 0.3rem;
				overflow: auto;
				clear: both;
				/*margin: 1rem auto;*/
				border: 0px solid #555;
			}
			
			.z_photo img {
				width: 1rem;
				height: 1rem;
			}
			
			.z_addImg {
				float: left;
				margin-right: 0.4rem;
			}
			
			.z_file {
				width: 1rem;
				height: 1rem;
				background: url(images/z_add.png) no-repeat;
				background-size: 100% 100%;
				float: left;
				margin-right: 0.4rem;
			}
			
			.z_file input::-webkit-file-upload-button {
				width: 1rem;
				height: 1rem;
				border: none;
				position: absolute;
				outline: 0;
				opacity: 0;
			}
			
			.z_file input#file {
				display: block;
				width: auto;
				border: 0;
				vertical-align: middle;
			}
			
			.mui-input-row label {
				width: 30%;
				font-size: smaller;
			}
			
			.mui-input-row input {
				padding-left: 10px!important;
				margin-bottom: 0;
			}
			
			.mui-navigate-right:after,
			.mui-push-right:after {
				right: 25px;
			}
			
			.show {}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="padding-right: 15px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">收购金饰信息</h1>
			<button id='setting' class=" mui-pull-right mui-btn-link">历史记录</button>
		</header>
		<div id="div1" class="mui-content">
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>物品名称</label>
					<input id='wpmc' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>数量</label>
					<input id='sl' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>重量</label>
					<input id='zl' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>价值</label>
					<input id='jz' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>特征描述</label>
					<input id='tzms' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>发现时间</label>
					<input id='fxsj' type="text" class="mui-input-clear mui-input" style="width: 65%;">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>发现地点</label>
					<input id='fxdd' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>可疑信息</label>
					<input id='kyxx' type="text" placeholder="无" class="mui-input-clear mui-input">
				</div>
			</div>

			<div class="container">
				<div class="mui-content-padded">
					<div class="mui-input-row">
						<label>物品照片</label>
					</div>
				</div>

				<!--    照片添加    -->
				<div class="z_photo">
					<div class="z_file">
						<input type="file" name="file" id="file" value="" accept="image/*" onchange="imgChange('z_photo','file',0);" />
					</div>
				</div>
			</div>

			<div class="mui-content-padded">
				<div class="mui-button-row">
					<button id='next' type="button" class="mui-btn mui-btn-block mui-btn-primary">下一步</button>
				</div>
			</div>
		</div>

		<div class="mui-content mui-hidden" id="div2">
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>姓名</label>
					<input id='xm' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>性别</label>
					<input id='xb' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>身份证号</label>
					<input id='sfzh' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>联系电话</label>
					<input id='lxdh' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>街道乡镇</label>
					<input id='jdxz' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>住址</label>
					<input id='zz' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>其他描述</label>
					<input id='qtms' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="container">
				<div class="mui-content-padded">
					<div class="mui-input-row">
						<label>人员照片</label>
					</div>
				</div>

				<div class="z_photo">
					<div class="z_file">
						<input type="file" name="file1" id="file1" value="" accept="image/*" multiple onchange="imgChange('z_photo','file1',1);" />
					</div>
				</div>
			</div>

			<div class="mui-content-padded">
				<div class="mui-button-row">
					<button id='submit' type="button" class="mui-btn mui-btn-block mui-btn-primary">提交</button>
				</div>
			</div>
		</div>

		<script src="js/mui.min.js"></script>
		<script src="js/jquery-1.11.0.min.js"></script>
		<script src="js/mui.picker.min.js"></script>
		<script src="js/app.js"></script>
		<script>
			/*
			 * 上传图片并获取URL
			 */
//			function imgUrlGet(imgContainer, base64) {
//				//var url = 'http://60.190.149.52:8015/tblDy/getImgUrl';
//				var url = 'http://60.190.149.52:8096/zxglxt/api/file/upload';
//				var fileExtension = base64.substr(11, 3);
//
//				$.ajax({
//					type: 'post',
//					url: 'http://60.190.149.52:8096/zkglxt/api/file/upload', // ajax请求路径
//					data: {
//						"base64": base64,
//						"fileExtension": fileExtension
//					},
//					success: function(data) {
//						var imgUrl = 'http://60.190.149.52:8096' + data.data;
//						var img = document.createElement("img");
//						img.setAttribute("src", imgUrl);
//						var imgAdd = document.createElement("div");
//						imgAdd.setAttribute("class", "z_addImg");
//						imgAdd.classList.add('show');
//						imgAdd.appendChild(img);
//						imgContainer.appendChild(imgAdd);
//						imgRemove();
//					}
//				});
//			}

			(function($, doc) {
				$.init();

				mui('#fxsj')[0].addEventListener("tap", function() {
					var options = {
						type: 'date'
					};
					var dtPicker = new mui.DtPicker(options);
					dtPicker.show(function(rs) {
						mui('#fxsj')[0].value = rs.text;
					})
				});

				mui('#setting')[0].addEventListener("tap", function() {
					//打开详情
					mui.openWindow({
						url: 'jewelrylist.html'
					});
				});

				mui('.mui-button-row').on('tap', '#next', function(event) {
					var check = true;
					mui("#div1 input").each(function() {
						if(this.type != 'file') {
							//若当前input为空，则alert提醒 
							if(!this.value || this.value.trim() == "") {
								var label = this.previousElementSibling;
								if(label.innerText == '可疑信息')
									return true;
									
								if(label.innerText == '身份证号')
									return true;
								mui.alert(label.innerText + "不允许为空");
								check = false;
								this.focus();
								return false;
							}
						}
					}); //校验通过，继续执行业务逻辑 

					if(check) {
						mui('#div1')[0].classList.add('mui-hidden');
						mui('#div2')[0].classList.remove('mui-hidden');
						mui('.mui-title')[0].innerHTML = '出售人信息';
					}
				})

				mui('.mui-button-row').on('tap', '#submit', function(event) {
					var check = true;
					mui("#div2 input").each(function() {
						if(this.type != 'file') {
							//若当前input为空，则alert提醒 
							if(!this.value || this.value.trim() == "") {
								var label = this.previousElementSibling;
								if(label.innerText == '身份证号')
									return true;
									
								if(label.innerText == '联系电话')
									return true;
									
								if(label.innerText == '街道乡镇')
									return true;
									
								mui.alert(label.innerText + "不允许为空");
								check = false;
								this.focus();
								return false;
							}
						}
					}); //校验通过，继续执行业务逻辑 
					if(check) {
						var rs = IdCodeValid(mui('#sfzh')[0].value);
						if(rs.pass)
							Submit();
						else {
							var btnArray = ['否', '是'];
							mui.confirm('身份证号格式不对，确定需要提交吗？', '确认', btnArray, function(e) {
								if(e.index == 1) {
									Submit();
								}
							});
						}
					}
				})

				function Submit() {
					var imgs = mui('#div1 .z_addImg.show img');
					var imgArr = [];
					mui.each(imgs, function(index, item) {
						imgArr.push(item.getAttribute('src').replace(IMAGE_SERVER_URL,''));
					});

					var jewelry = {
						wpmc: mui('#wpmc')[0].value,
						sl: mui('#sl')[0].value,
						zl: mui('#zl')[0].value,
						jz: mui('#jz')[0].value,
						tzms: mui('#tzms')[0].value,
						fxsj: mui('#fxsj')[0].value,
						fxdd: mui('#fxdd')[0].value,
						wpzp: JSON.stringify(imgArr),
						kyxx: mui('#kyxx')[0].value,
						dyId: localStorage.getItem("Id"),
						creator: localStorage.getItem("Creator")
					};

					imgs = mui('#div2 .z_addImg.show img');
					imgArr.splice(0)
					mui.each(imgs, function(index, item) {
						imgArr.push(item.getAttribute('src').replace(IMAGE_SERVER_URL,''));
					});
					var csr = {
						xm: mui('#xm')[0].value,
						xb: mui('#xb')[0].value,
						sfzh: mui('#sfzh')[0].value,
						lxdh: mui('#lxdh')[0].value,
						jdxz: mui('#jdxz')[0].value,
						zz: mui('#zz')[0].value,
						qtms: mui('#qtms')[0].value,
						ryzp: JSON.stringify(imgArr),
						type: '金饰'
					};

					mui.ajax({
						url: 'http://60.190.149.52:8015/tblJewelry/add',
						data: {
							tblJewelry: jewelry,
							tblCsr: csr
						},
						async: true,
						dataType: 'json',
						crossDomain: true, //强制使用5+跨域  
						type: 'post',
						timeout: 10000,
						headers: {
							'Content-Type': 'application/json'
						},
						success: function(result) {
							mui.alert('提交成功！', function() {
								//打开详情
								mui.openWindow({
									url: 'jewelrydetail.html?id=' + result.data
								});
							})
						},
						error: function(xhr, type, errorThrown) {}
					});
				}
			}(mui, document));
		</script>
	</body>

</html>