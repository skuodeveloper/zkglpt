<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
		<style>
			.container {
				width: 100%;
				height: 100%;
				overflow: auto;
				clear: both;
			}
			
			.z_photo {
				width: 100%;
				height: 3rem;
				padding: 0.3rem;
				overflow: auto;
				clear: both;
				/*margin: 1rem auto;*/
				border: 0px solid #555;
			}
			
			.z_photo img {
				width: 1rem;
				height: 1rem;
			}
			
			.z_addImg {
				float: left;
				margin-right: 0.4rem;
			}
			
			.z_file {
				width: 1rem;
				height: 1rem;
				background: url(images/z_add.png) no-repeat;
				background-size: 100% 100%;
				float: left;
				margin-right: 0.4rem;
			}
			
			.z_file input::-webkit-file-upload-button {
				width: 1rem;
				height: 1rem;
				border: none;
				position: absolute;
				outline: 0;
				opacity: 0;
			}
			
			.z_file input#file {
				display: block;
				width: auto;
				border: 0;
				vertical-align: middle;
			}
			
			.mui-input-row label {
				width: 30%;
				font-size: smaller;
			}
			
			.mui-input-row input {
				padding-left: 10px!important;
				margin-bottom: 0;
			}
			
			.mui-navigate-right:after,
			.mui-push-right:after {
				right: 25px;
			}
			
			.show {}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="padding-right: 15px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">收购手机信息</h1>
			<button id='setting' class=" mui-pull-right mui-btn-link">历史记录</button>
		</header>
		<div id="div1" class="mui-content">
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<a class="mui-navigate-right">
						<label>品牌</label>
						<input id='brand' type="text" class="mui-input-clear mui-input" style="width: 65%;">
					</a>
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>型号</label>
					<input id='xh' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>串号</label>
					<input id='ch' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<a class="mui-navigate-right">
						<label>颜色</label>
						<input id='color' type="text" class="mui-input-clear mui-input" style="width: 65%;">
					</a>
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>价值</label>
					<input id='jz' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>收购时间</label>
					<input id='sgsj' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>可疑信息</label>
					<input id='kyxx' type="text" class="mui-input-clear mui-input">
				</div>
			</div>

			<div class="container">
				<div class="mui-content-padded">
					<div class="mui-input-row">
						<label>物品照片</label>
					</div>
				</div>

				<!--    照片添加    -->
				<div class="z_photo">
					<div class="z_file">
						<input type="file" name="file" id="file" value="" accept="image/*" onchange="imgChange('z_photo','file',0);" />
					</div>
				</div>
			</div>

			<div class="mui-content-padded">
				<div class="mui-button-row">
					<button id='next' type="button" class="mui-btn mui-btn-block mui-btn-primary">下一步</button>
				</div>
			</div>
		</div>

		<div class="mui-content mui-hidden" id="div2">
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>姓名</label>
					<input id='xm' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>性别</label>
					<input id='xb' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>身份证号</label>
					<input id='sfzh' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>联系电话</label>
					<input id='lxdh' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>街道乡镇</label>
					<input id='jdxz' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>住址</label>
					<input id='zz' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row">
					<label>其他描述</label>
					<input id='qtms' type="text" class="mui-input-clear mui-input">
				</div>
			</div>
			<div class="container">
				<div class="mui-content-padded">
					<div class="mui-input-row">
						<label>人员照片</label>
					</div>
				</div>

				<div class="z_photo">
					<div class="z_file">
						<input type="file" name="file1" id="file1" value="" accept="image/*" multiple onchange="imgChange('z_photo','file1',1);" />
					</div>
				</div>
			</div>

			<div class="mui-content-padded">
				<div class="mui-button-row">
					<button id='submit' type="button" class="mui-btn mui-btn-block mui-btn-primary">提交</button>
				</div>
			</div>
		</div>

		<script src="js/mui.min.js"></script>
		<script src="js/jquery-1.11.0.min.js"></script>
		<script src="js/mui.picker.min.js"></script>
		<script src="js/app.js"></script>
		<script>
			//px转换为rem
			(function(doc, win) {
				var docEl = doc.documentElement,
					resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
					recalc = function() {
						var clientWidth = docEl.clientWidth;
						if(!clientWidth) return;
						if(clientWidth >= 640) {
							docEl.style.fontSize = '100px';
						} else {
							docEl.style.fontSize = 100 * (clientWidth / 640) + 'px';
						}
					};

				if(!doc.addEventListener) return;
				win.addEventListener(resizeEvt, recalc, false);
				doc.addEventListener('DOMContentLoaded', recalc, false);
			})(document, window);

			function imgChange(obj1, obj2, idx) {
				//				$('#div1 .z_addImg').filter(function(){ return $(this).css('display')!='none';}).length;
				switch(idx) {
					case 0:
						var imgCnt = mui('#div1 .z_addImg.show img').length;
						//						mui('#div1 .z_addImg.show img')[0].getAttribute('src');

						if(imgCnt > 5) {
							mui.alert('物品信息最多只能上传6张图片！');
							return;
						}
						break;
					case 1:
						var imgCnt = mui('#div2 .z_addImg.show').length;
						if(imgCnt > 0) {
							mui.alert('最多只能上传一张人员照片');
							return;
						}
						break;
				}

				//获取点击的文本框
				var file = document.getElementById(obj2);
				//存放图片的父级元素
				var imgContainer = document.getElementsByClassName(obj1)[idx];
				//获取的图片文件
				var fileList = file.files;
				//遍历获取到得图片文件
				for(var i = 0; i < fileList.length; i++) {
					imgBase64Get(file.files[i], imgContainer, imgUrlGet);
				};
			};

			/*
			 * 获取上传图片的Base64编码
			 */
			function imgBase64Get(file, imgContainer, callback) {
				var reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = function(e) {
					callback(imgContainer, this.result);
				}
			}

			/*
			 * 上传图片并获取URL
			 */
			function imgUrlGet(imgContainer, base64) {
				var url = 'http://60.190.149.52:8015/tblDy/getImgUrl';
				var fileExtension = base64.substr(11,3);
				
				mui.ajax(url, {
					data: {
						base64: base64,
						fileExtension: fileExtension
					},
					dataType: 'text', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						var imgUrl = data;
						var img = document.createElement("img");
						img.setAttribute("src", imgUrl);
						var imgAdd = document.createElement("div");
						imgAdd.setAttribute("class", "z_addImg");
						imgAdd.classList.add('show');
						imgAdd.appendChild(img);
						imgContainer.appendChild(imgAdd);
						imgRemove();
					}
				});
			}

			function imgRemove() {
				var imgList = mui('.z_addImg');
				for(var j = 0; j < imgList.length; j++) {
					imgList[j].index = j;
					imgList[j].onclick = function() {
						var t = this;
						mui.confirm("确定要删除这张图片吗?", function(e) {
							if(e.index == 1) {
								//点确定了
								t.style.display = "none";
								t.classList.remove('show');
							}
						});
					}
				};
			};

			(function($, doc) {
				$.init();

				mui('#brand')[0].addEventListener("tap", function() {
					document.activeElement.blur();
					SelectBrand();
				});

				mui('#color')[0].addEventListener("tap", function() {
					document.activeElement.blur();
					SelectColor();
				});

				mui('#sgsj')[0].addEventListener("tap", function() {
					var options = {
						type: 'date'
					};
					var dtPicker = new mui.DtPicker(options);
					dtPicker.show(function(rs) {
						mui('#sgsj')[0].value = rs.text;
					})
				});

				mui('#setting')[0].addEventListener("tap", function() {
					//打开详情
					mui.openWindow({
						url: 'phonelist.html',
						show: {
							aniShow: 'pop-in'
						},
						waiting: {
							autoShow: true, //自动显示等待框，默认为true
						}
					});
				});

				mui('.mui-button-row').on('tap', '#next', function(event) {
					var check = true;
					mui("#div1 input").each(function() {
						if(this.type != 'file') {
							//若当前input为空，则alert提醒 
							if(!this.value || this.value.trim() == "") {
								var label = this.previousElementSibling;
								if(label.innerText == '可疑信息')
									return true;

								mui.alert(label.innerText + "不允许为空");
								check = false;
								this.focus();
								return false;
							}
						}
					}); //校验通过，继续执行业务逻辑 

					if(check) {
						mui('#div1')[0].classList.add('mui-hidden');
						mui('#div2')[0].classList.remove('mui-hidden');
						mui('.mui-title')[0].innerHTML = '出售人信息';
					}
				})

				mui('.mui-button-row').on('tap', '#submit', function(event) {
					var check = true;
					mui("#div2 input").each(function() {
						if(this.type != 'file') {
							//若当前input为空，则alert提醒 
							if(!this.value || this.value.trim() == "") {
								var label = this.previousElementSibling;
								if(label.innerText == '可疑信息')
									return true;

								mui.alert(label.innerText + "不允许为空");
								check = false;
								this.focus();
								return false;
							}
						}
					}); //校验通过，继续执行业务逻辑

					if(check) {
						var rs = IdCodeValid(mui('#sfzh')[0].value);
						if(rs.pass)
							Submit();
						else
							mui.alert(rs.msg);
					}
				})

				function SelectBrand() {
					var specModel = new mui.PopPicker(); //初始化 picker
					mui.ajax({
						url: 'http://60.190.149.52:8015/tblPhoneBrand/get',
						data: {},
						async: true,
						dataType: 'json',
						crossDomain: true, //强制使用5+跨域  
						type: 'get',
						timeout: 10000,
						success: function(data) {
							//							console.log(data);
							if(data.length > 0) {
								var item = [];
								for(var i = 0; i < data.length; i++) {
									arrStr = {
										text: data[i].brandName,
										value: data[i].brandName
									};
									item.push(arrStr);
								}
								specModel.setData(item);
								specModel.show(function(item) {
									var specModelName = item[0].text;
									var t = document.getElementById('brand');
									t.value = specModelName;
									t.tabIndex = item[0].value;
									var specModelValue = item[0].Id;
								});
							}
						}
					});
				}

				function SelectColor() {
					var specModel = new mui.PopPicker(); //初始化 picker
					mui.ajax({
						url: 'http://60.190.149.52:8015/tblComputerColor/get',
						data: {},
						async: true,
						dataType: 'json',
						crossDomain: true, //强制使用5+跨域  
						type: 'get',
						timeout: 10000,
						success: function(data) {
							//							console.log(data);
							if(data.length > 0) {
								var item = [];
								for(var i = 0; i < data.length; i++) {
									arrStr = {
										text: data[i].colorName,
										value: data[i].colorName
									};
									item.push(arrStr);
								}
								specModel.setData(item);
								specModel.show(function(item) {
									var specModelName = item[0].text;
									var t = document.getElementById('color');
									t.value = specModelName;
								});
							}
						}
					});
				}

				function Submit() {
					var imgs = mui('#div1 .z_addImg.show img');
					var imgArr = [];
					mui.each(imgs, function(index, item) {
						imgArr.push(item.getAttribute('src'));
					});

					var phone = {
						brand: mui('#brand')[0].value,
						xh: mui('#xh')[0].value,
						ch: mui('#ch')[0].value,
						color: mui('#color')[0].value,
						jz: mui('#jz')[0].value,
						sgsj: mui('#sgsj')[0].value,
						wpzp: JSON.stringify(imgArr),
						kyxx: mui('#kyxx')[0].value,
						dyId: localStorage.getItem("Id"),
						creator: localStorage.getItem("Creator")
					};

					imgs = mui('#div2 .z_addImg.show img');
					imgArr.splice(0)
					mui.each(imgs, function(index, item) {
						imgArr.push(item.getAttribute('src'));
					});
					var csr = {
						xm: mui('#xm')[0].value,
						xb: mui('#xb')[0].value,
						sfzh: mui('#sfzh')[0].value,
						lxdh: mui('#lxdh')[0].value,
						jdxz: mui('#jdxz')[0].value,
						zz: mui('#zz')[0].value,
						qtms: mui('#qtms')[0].value,
						ryzp: JSON.stringify(imgArr),
						type: '手机'
					};

					mui.ajax({
						url: 'http://60.190.149.52:8015/tblPhone/add',
						data: {
							tblPhone: phone,
							tblCsr: csr
						},
						async: true,
						dataType: 'json',
						crossDomain: true, //强制使用5+跨域  
						type: 'post',
						timeout: 10000,
						headers: {
							'Content-Type': 'application/json'
						},
						success: function(result) {
							mui.alert('提交成功！', function() {
								//打开详情
								mui.openWindow({
									url: 'phonedetail.html?id=' + result.data,
									show: {
										aniShow: 'pop-in'
									},
									waiting: {
										autoShow: true, //自动显示等待框，默认为true
									}
								});
							})
						},
						error: function(xhr, type, errorThrown) {}
					});
				}
			}(mui, document));
		</script>
	</body>

</html>